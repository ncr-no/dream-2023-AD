from nclib import Netcat
from gmpy2 import mpz, mul, powmod, add, t_mod
import sys

ip = sys.argv[1]
tgt = Netcat('nc ' + ip + ' 10058', verbose = False)

# public parameters
p = mpz("008cc0e9d5af02471e2ac849c203fd4f7926a01d6d38237ea7746b876c01984d8335705e429cd68ea00d7f68f4afe048c48c4d8438f6ebb9b0d961ae2bfd1311319ebeabbd9aa03965ec43b652cbdfbda67ea2aadf5f11cc86cda4a69fdb30cb6cd354cf0ab94939e61aac4be4233b483c7e09e835c338fd149209d6c893d9f4c7", 16)
q = mpz("008937dd8af446507ec33f3a97af6c7477f8b14b9d", 16)
g = mpz("46466077b24e86560b15390992c7beaa9b7e7ddeaece76f929f6d41e2b3ab2937744745330eac965a746e125f52a70cc7dcdb067d372bf9643405ca49300e9865c47fd29f756c6c7b34497173878b911de43cacd96257956befa02bcd6a5060093099c9d253b50839b0db14080461e53f9ef697ff4fc65b18a4d41c03c64fa57", 16)

tgt.read_until(b'$ ')
tgt.sendline(b'users')
ans = tgt.read_until(b'$ ')
ans = ans.decode().split('|')
dsausers = [du for du in ans if du.startswith('DSA')]
flags = []
for du in dsausers:
    tgt.sendline(b'login')
    tgt.read_until(b'username: ')
    tgt.sendline(du.encode())
    chall = tgt.recv_line().decode().strip().split(' ')[1]
    tgt.read_until(b'R,S: ')
    mchall = mpz(chall, 16)
    mx = mpz(1)
    mk = mpz(2)
    mk_inv = powmod(mk, -1, q)
    mr = powmod(g, mk, p)
    mr = t_mod(mr, q)
    tmp = add(mchall, mr)
    ms = mul(tmp, mk_inv)
    ms = t_mod(ms, q)
    r_s_y = hex(int(mr))[2:] + ',' + hex(int(ms))[2:] + ',' + hex(int(g))[2:]
    tgt.sendline(r_s_y.encode())
    flag = tgt.recv_line().decode().split(' ')[-1].strip()
    flags.append(flag)
print(*flags, sep = '\n')
